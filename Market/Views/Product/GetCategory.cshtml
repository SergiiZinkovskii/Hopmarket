@model List<Market.Domain.Entity.Product>

@{
    ViewBag.Title = "Список товарів";
    Layout = "_Layout";
}

<style>
    .card-buttons-group {
        text-align: right;
        padding: 10px;
    }
</style>


@if (User.IsInRole("Admin"))
{
    <div class="card col-md-12" style="margin: 10px;">
        <div class="card-buttons-group">
            <button class='btn btn-success' id='addProductId'>Додати</button>
        </div>
    </div>
}
<div style="padding: 10px;"></div>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <form method="get">
                <div class="form-group">
                    <label for="sortSelect">Сортувати за ціною:</label>
                    <select id="sortSelect" name="sortOrder" class="form-control" onchange="sortProducts()">
                        <option value="asc">За зростанням</option>
                        <option value="desc">За спаданням</option>
                    </select>
                </div>
            </form>
        </div>
    </div>
</div>

@if (Model == null)
{
    <div class="col-md-8">
        <div class="card-body">
            <h5 class="card-title text-center">Список товарів пустий :(</h5>
            <p class="card-text">
                Список в процесі створення
            </p>
        </div>
    </div>
}
else
{
    <div id="productsContainer" class="row">
        @foreach (var product in Model)
        {
            <div class="col-md-3">
                <div class="card">
                    @if (product.Photos != null && product.Photos.Any())
                    {
                        var photo = product.Photos.FirstOrDefault();
                        if (photo != null && photo.ImageData != null)
                        {
                            <img style="max-height: 300px; width: contain" src="data:image/jpeg;base64,@Convert.ToBase64String(photo.ImageData)" alt="@product.Name" />
                        }
                        else
                        {
                            <img style="max-height: 300px; width: contain" src="https://example.com/default-image.jpg" alt="@product.Name" />
                        }
                    }
                    else
                    {
                        <img style="max-height: 300px; width: contain" src="https://example.com/default-image.jpg" alt="@product.Name" />
                    }
                    <div class="card-body">
                        <h5 class="card-title">@product.Name</h5>
                        <p class="card-text">Опис: @product.Description ...</p>
                    </div>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">Вартість: @product.Price ₴</li>
                        <li class="list-group-item">Модель: @product.Model</li>
                    </ul>
                    <div class="card-body">
                        <a href="@Url.Action("GetProduct", "Product", new { id = product.Id })" class="btn btn-primary">
                            Відкрити
                        </a>
                        @if (User.IsInRole("Admin"))
                        {
                            <a asp-controller="Product" asp-action="Delete" asp-route-id="@product.Id" class="btn btn-danger">Видалити</a>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
}


@section pageScripts {

    <script src="~/js/modal.js"></script>


    <script>
        $(function () {


            $('#addProductId').on('click', function () {
                $.ajax({
                    type: 'GET',
                    url: '/Product/Save',
                    success: function (response) {
                        $('.modal-dialog').removeClass("modal-lg");
                        modal.find(".modal-body").html(response);

                        app.initProductTypeSelect(modal.find('.product-type-select'));

                        modal.modal('show');
                    },
                    failure: function () {
                        modal.modal('hide')
                    },
                    error: function (response) {
                        alert(response.responseText);
                    }
                });
            });
        });
    </script>

    <script>
        function sortProducts() {
            var select = document.getElementById("sortSelect");
            var sortOrder = select.options[select.selectedIndex].value;

            var productsContainer = document.getElementById("productsContainer");
            var products = Array.from(productsContainer.getElementsByClassName("col-md-3"));

            products.sort(function (a, b) {
                var priceA = parseFloat(a.getElementsByClassName('list-group-item')[0].textContent.replace('Вартість: ', '').replace(' ₴', ''));
                var priceB = parseFloat(b.getElementsByClassName('list-group-item')[0].textContent.replace('Вартість: ', '').replace(' ₴', ''));

                if (sortOrder === 'asc') {
                    return priceA - priceB;
                } else if (sortOrder === 'desc') {
                    return priceB - priceA;
                }
            });

            products.forEach(function (product) {
                productsContainer.appendChild(product);
            });
        }


    </script>
}
